<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>ƒê·∫∑t l·ªãch Spa</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #fceeee;
            display: flex;
            justify-content: center;
            padding: 40px;
        }

        .form-container {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            width: 400px;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
        }

        .form-container h2 {
            text-align: center;
            color: #d6336c;
        }

        label {
            display: block;
            margin-top: 20px;
            font-weight: bold;
        }

        input, select, button {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }

        .time-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .time-button {
            background: #fff;
            border: 1px solid #d6336c;
            color: #d6336c;
            border-radius: 5px;
            padding: 8px;
            cursor: pointer;
            text-align: center;
        }

        .time-button.active {
            background: #d6336c;
            color: white;
        }

        .time-button.disabled-slot {
            background: #eee;
            color: #999;
            border-color: #ccc;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body>
<div class="form-container">
    <h2>ƒê·∫∑t l·ªãch Spa</h2>
    <form id="bookingForm">
        <label>H·ªç v√† t√™n:</label>
        <input type="text" id="name" required>

        <label>S·ªë ƒëi·ªán tho·∫°i:</label>
        <input type="text" id="phone" required>

        <label>D·ªãch v·ª•:</label>
        <select id="service">
            <option value="1">ChƒÉm s√≥c da c∆° b·∫£n</option>
            <option value="2">Massage th∆∞ gi√£n</option>
        </select>

        <label>Chi nh√°nh:</label>
        <select id="branch">
            <option value="1">2/3 T√¥ K√Ω, H√≥c M√¥n</option>
        </select>

        <label>Ch·ªçn ng√†y:</label>
        <input type="date" id="date" required>

        <label>Ch·ªçn gi·ªù:</label>
        <div class="time-buttons" id="timeButtons"></div>

        <button type="submit">X√°c nh·∫≠n</button>
    </form>
</div>

<!-- ph·∫ßn head gi·ªØ nguy√™n nh∆∞ b·∫°n g·ª≠i -->

<script>
    const times = [
        "09:00", "09:30", "10:00", "10:30",
        "11:00", "11:30", "13:00", "13:30",
        "14:00", "14:30", "15:00", "15:30",
        "16:00", "16:30", "17:00", "17:30",
        "18:00", "18:30", "19:00", "19:30"
    ];

    const timeContainer = document.getElementById("timeButtons");
    let selectedTime = null;

    function renderTimeButtons(bookedTimes = []) {
        timeContainer.innerHTML = "";
        times.forEach(time => {
            const btn = document.createElement("div");
            btn.classList.add("time-button");
            btn.textContent = time;

            if (bookedTimes.includes(time)) {
                btn.classList.add("disabled-slot");
            } else {
                btn.onclick = () => {
                    document.querySelectorAll(".time-button").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                    selectedTime = time;
                };
            }

            timeContainer.appendChild(btn);
        });
    }

    async function fetchBookedTimes(branchId, dateStr) {
        const url = `http://localhost:8080/api/datlich/check?branchId=${branchId}&date=${dateStr}`;
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error("API l·ªói");
            return await res.json(); // Ex: ["10:00", "14:30"]
        } catch (e) {
            console.error(e);
            return [];
        }
    }

    async function updateDisabledSlots() {
        const date = document.getElementById("date").value;
        const branchId = document.getElementById("branch").value;
        if (date && branchId) {
            const booked = await fetchBookedTimes(branchId, date);
            renderTimeButtons(booked);
        }
    }

    document.getElementById("date").addEventListener("change", updateDisabledSlots);
    document.getElementById("branch").addEventListener("change", updateDisabledSlots);

    document.getElementById("bookingForm").addEventListener("submit", async function (e) {
    e.preventDefault();

    const name = document.getElementById("name").value.trim();
    const phone = document.getElementById("phone").value.trim();
    const serviceSelect = document.getElementById("service");
    const branchSelect = document.getElementById("branch");
    const date = document.getElementById("date").value;

    if (!name || !phone || !date || !selectedTime) {
        alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin v√† ch·ªçn gi·ªù!");
        return;
    }

    const serviceId = serviceSelect.value;
    const branchId = branchSelect.value;
    const serviceName = serviceSelect.options[serviceSelect.selectedIndex].text;
    const branchName = branchSelect.options[branchSelect.selectedIndex].text;
    const appointmentTime = `${date}T${selectedTime}:00`;

    try {
        // üîÅ G·ªçi API t·∫°o ho·∫∑c l·∫•y user theo s·ªë ƒëi·ªán tho·∫°i
        const userRes = await fetch("http://localhost:8080/api/user/create-or-get", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, phone })
        });

        const user = await userRes.json();
        if (!userRes.ok) {
            alert("‚ùå L·ªói khi t·∫°o/l·∫•y ng∆∞·ªùi d√πng.");
            return;
        }

        // üîÅ G·ªçi API ƒë·∫∑t l·ªãch
        const res = await fetch("http://localhost:8080/api/datlich", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                userId: user.id,
                serviceId: Number(serviceId),
                branchId: Number(branchId),
                appointmentTime
            })
        });

        const result = await res.json();
        if (res.ok) {
            // L∆∞u localStorage
            localStorage.setItem("lastBooking", JSON.stringify({
                name, phone, service: serviceName, branch: branchName,
                time: `${selectedTime} ng√†y ${date.split("-").reverse().join("-")}`
            }));

            // Chuy·ªÉn trang
            window.location.href = "success.html";
        } else {
            alert("‚ùå ƒê·∫∑t l·ªãch th·∫•t b·∫°i: " + result.message);
        }

    } catch (error) {
        alert("‚ùå L·ªói k·∫øt n·ªëi ƒë·∫øn server.");
        console.error(error);
    }
});


    renderTimeButtons();
</script>

</body>
</html>
